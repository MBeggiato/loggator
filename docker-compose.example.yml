# Loggator - Docker Log Aggregator
# Beispiel docker-compose.yml für die Verwendung des fertigen Images
#
# Verwendung:
#   1. Diese Datei als docker-compose.yml speichern
#   2. Eigenen MEILISEARCH_MASTER_KEY generieren (siehe unten)
#   3. Optional: .env Datei mit OPENROUTER_API_KEY anlegen für AI-Chat
#   4. docker-compose up -d
#
# Key generieren (Linux/Mac):
#   openssl rand -base64 32
#
# Beispiel-Key (NICHT in Produktion verwenden!):
#   MEILISEARCH_MASTER_KEY=aSampleMasterKey1234567890abcdef
#
# AI Chat (optional):
#   OPENROUTER_API_KEY=sk-or-v1-...
#   AI_MODEL=xiaomi/mimo-v2-flash:free
#   SITE_URL=https://your-domain.com

services:
  loggator:
    image: ghcr.io/mbeggiato/loggator:latest
    container_name: loggator
    ports:
      - '3000:3000'
    environment:
      - MEILISEARCH_HOST=http://meilisearch:7700
      - MEILISEARCH_API_KEY=${MEILISEARCH_MASTER_KEY:-aSampleMasterKey1234567890abcdef}
      - DOCKER_LABEL_FILTER=loggator.enable=true
      # AI Chat (optional - nur setzen wenn AI-Features genutzt werden)
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - AI_MODEL=${AI_MODEL:-xiaomi/mimo-v2-flash:free}
      - SITE_URL=${SITE_URL:-http://localhost:3000}
      # Apprise für Benachrichtigungen
      - APPRISE_API_URL=http://apprise:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      meilisearch:
        condition: service_healthy
      apprise:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - loggator-network

  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: loggator-meilisearch
    ports:
      - '7700:7700'
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_MASTER_KEY=${MEILISEARCH_MASTER_KEY:-aSampleMasterKey1234567890abcdef}
    volumes:
      - meilisearch-data:/meili_data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:7700/health']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - loggator-network

  apprise:
    image: caronc/apprise:latest
    container_name: loggator-apprise
    ports:
      - '8000:8000'
    environment:
      - APPRISE_STATELESS_URLS=Yes
    volumes:
      - apprise-data:/config
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:8000/ || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - loggator-network

networks:
  loggator-network:
    driver: bridge

volumes:
  meilisearch-data:
  apprise-data:

services:
  loggator:
    build: .
    container_name: loggator
    ports:
      - '3000:3000'
    environment:
      - MEILISEARCH_HOST=http://meilisearch:7700
      - MEILISEARCH_API_KEY=${MEILISEARCH_API_KEY:-bLwLpwgIW6VQTBrt7ZhUw9MiJXYh8Vat7YVr4lU-5XA}
      - DOCKER_LABEL_FILTER=loggator.enable=true
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - AI_MODEL=${AI_MODEL:-xiaomi/mimo-v2-flash:free}
      - SITE_URL=${SITE_URL:-http://localhost:3000}
      - APPRISE_API_URL=http://apprise:8000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      meilisearch:
        condition: service_healthy
      apprise:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - loggator-network

  meilisearch:
    image: getmeili/meilisearch:latest
    container_name: loggator-meilisearch
    ports:
      - '7700:7700'
    environment:
      - MEILI_NO_ANALYTICS=true
      - MEILI_MASTER_KEY=${MEILISEARCH_MASTER_KEY:-bLwLpwgIW6VQTBrt7ZhUw9MiJXYh8Vat7YVr4lU-5XA}
    volumes:
      - ./meilisearch-data:/meili_data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:7700/health']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - loggator-network

  apprise:
    image: caronc/apprise:latest
    container_name: loggator-apprise
    ports:
      - '8000:8000'
    environment:
      - APPRISE_STATELESS_URLS=Yes
    volumes:
      - ./apprise-data:/config
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:8000/ || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - loggator-network

  test-logger:
    image: alpine:latest
    labels:
      - 'loggator.enable=true'
    command: >
      sh -c "while true; do
        echo '[INFO] Application started';
        sleep 2;
        echo '[DEBUG] Processing task';
        sleep 3;
        echo '[WARN] Memory usage high';
        sleep 2;
        echo '[ERROR] Connection timeout';
        sleep 4;
      done"
    networks:
      - loggator-network

networks:
  loggator-network:
    driver: bridge
